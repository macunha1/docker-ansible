FROM "{{ distro }}:{{ image_version }}"

RUN apt-get update -y && \
    apt-get install --fix-missing && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        sudo curl gcc libffi-dev libssl-dev iproute2 \
    {%- if python3.enabled %}
        python3 python3-pip python3-dev python3-yaml python3-apt \
    {%- else %}
        python python-pip python-dev python-yaml \
    {%- endif %}
    {%- if java.enabled %}
        $(apt-cache search --names-only '^openjdk-(8|11)-jre$' | \
            awk '{ print $1 }') \
    {%- endif %}
        sshpass openssh-client && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/*

RUN {% if python3.enabled -%}
    ln -s $(which python3) $(dirname $(which python3))/python && \
    ln -s $(which python3) /usr/local/bin/python && \
    pip3 install -U pip && \
{%- else -%}
    EASY_INSTALL=$(command -v easy_install || \
        echo "$(which pip) install") && \
    $EASY_INSTALL -U pip && \
{%- endif %}
    pip install -U setuptools pyopenssl && \
    pip install -U --ignore-installed cffi pywinrm && \
    pip install ansible=={{ ansible.version }} && \
    # Adding Ansible hosts for convenience
    mkdir -p /etc/ansible && \
    echo 'localhost' > /etc/ansible/hosts

ENTRYPOINT [ "ansible-playbook" ]
